name: Test local iso building
on:
  push:
    paths:
    - 'conf/**'
    - 'packages/**'
    - '.github/workflows/**'
  pull_request:
    paths:
    - 'conf/**'
    - 'packages/**'
    - '.github/workflows/**'
jobs:
  iso:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - run: |
        git fetch --prune --unshallow

    - name: setup-docker
      uses: docker-practice/actions-setup-docker@0.0.1

    - name: Install deps
      run: |
        sudo apt-get install -y xorriso squashfs-tools dosfstools
        sudo -E make deps

    # We patch docker to use all the HD available in GH action free runners
    - name: Patch Docker Daemon data-root
      run: |
        DOCKER_DATA_ROOT='/mnt/var/lib/docker'
        DOCKER_DAEMON_JSON='/etc/docker/daemon.json'
        sudo mkdir -p "${DOCKER_DATA_ROOT}"
        jq --arg dataroot "${DOCKER_DATA_ROOT}" '. + {"data-root": $dataroot}' "${DOCKER_DAEMON_JSON}" > "/tmp/docker.json.tmp"
        sudo mv "/tmp/docker.json.tmp" "${DOCKER_DAEMON_JSON}"
        sudo systemctl restart docker

    - name: Validate ðŸŒ³
      run: |
        make validate

    - name: Build packages ðŸ”§
      run: |
        sudo -E make build
        ls -liah $PWD/build
    - name: Create repository ðŸ”§
      run: |
        sudo -E make create-repo
        ls -liah $PWD/build

    - name: Build ISO ðŸ”§
      run: |
        sudo -E make local-iso
    - uses: actions/upload-artifact@v2
      with:
        name: ISO
        path: |
          *.iso
          *.sha256
    - uses: actions/upload-artifact@v2
      if: always()
      with:
        name: build-log
        path: isowork/*.log
